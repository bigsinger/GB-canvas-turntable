<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GB Canvas Turntable</title>
  <link rel="stylesheet" href="css/typo/typo.css">
  <link rel="stylesheet" href="css/GB-canvas-turntable.css">
  <style>
    .wrapper {
      padding: 20px 40px;
    }

    .fork-github {
      position: fixed;
      right: -100px;
      top: 45px;
      z-index: 9999;
      padding: 2px 100px;
      font-size: 12px;
      background-color: #444;
      border: 1px solid #000;
      -webkit-transform: rotate(45deg);
      -ms-transform: rotate(45deg);
      transform: rotate(45deg);
      text-align: center;
    }

    .fork-github a {
      color: #fff;
    }

    .gb-turntable a.gb-turntable-btn {
      border: none;
    }

  </style>
</head>

<body ontouchstart>
  <div class="wrapper typo" id="wrapper">
    <h1 id="scene-title">抽奖</h1>
    <section id="turntable" class="gb-turntable">
      <div class="gb-turntable-container">
        <canvas class="gb-turntable-canvas" width="300" height="300px">抱歉！浏览器不支持。</canvas>
      </div>

      <a class="gb-turntable-btn" href="javascript:;">抽奖</a>
    </section>
  </div>

  <script src="js/GB-canvas-turntable.js"></script>
  <script>
	  // 解析 URL 中的 scene 参数（默认是 default）
	  function getSceneNameFromUrl() {
		const params = new URLSearchParams(window.location.search);
		return params.get("scene") || "default";
	  }

	  // 读取 JSON 场景配置文件
	  function loadSceneConfig(sceneName, callback) {
		fetch(`sln/${sceneName}.json`)
		  .then(response => {
			if (!response.ok) throw new Error("加载失败");
			return response.json();
		  })
		  .then(data => {
			callback(data);
		  })
		  .catch(error => {
			console.warn(`加载场景 ${sceneName}.json 失败，尝试加载默认配置`, error);
			// fallback: 默认配置
			fetch(`sln/default.json`)
			  .then(res => res.json())
			  .then(data => callback(data))
			  .catch(() => callback([])); // 兜底空配置
		  });
	  }
	  
	// Fisher-Yates 洗牌算法
	function shuffle(array) {
	  for (let i = array.length - 1; i > 0; i--) {
		let j = Math.floor(Math.random() * (i + 1));
		[array[i], array[j]] = [array[j], array[i]];
	  }
	  return array;
	}

	// 根据权重扩展数组
	function expandByWeight(items) {
	  const expanded = [];
	  items.forEach(item => {
		const count = (typeof item.weight === 'number' && item.weight > 0) ? Math.floor(item.weight) : 1;
	  console.log(count);
		for (let i = 0; i < count; i++) {
		  expanded.push(item);
		}
	  });
	  return shuffle(expanded);
	}

	  document.addEventListener('DOMContentLoaded', function () {
	  const sceneName = getSceneNameFromUrl();
	  console.log(sceneName);

	  loadSceneConfig(sceneName, function (configData) {
		// 扩展并洗牌，缓存扩展后的数组
		const expandedConfig = expandByWeight(configData);
	  console.log(configData);
	  console.log(expandedConfig);

		gbTurntable.init({
		  id: 'turntable',
		  config: function (callback) {
			callback && callback(configData);
		  },
		  getPrize: function (callback) {
			const total = expandedConfig.length;
			const num = Math.floor(Math.random() * total);
			// expandedConfig[num] 就是抽中的奖品对象
			const indexInOriginal = configData.indexOf(expandedConfig[num]);
			const chances = 1;
			console.log(total, num, indexInOriginal);
			callback && callback([indexInOriginal, chances]);
		  },
		  gotBack: function (data) {
			alert('恭喜抽中：' + data);
		  }
		});
	  });
	});
  </script>
</body>

</html>
