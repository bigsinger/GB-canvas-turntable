<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>抽奖</title>
	<link rel="stylesheet" href="css/typo/typo.css">
	<link rel="stylesheet" href="css/GB-canvas-turntable.css">
	<style>
		.wrapper {
			padding: 20px 40px;
		}

		.fork-github {
			position: fixed;
			right: -100px;
			top: 45px;
			z-index: 9999;
			padding: 2px 100px;
			font-size: 12px;
			background-color: #444;
			border: 1px solid #000;
			-webkit-transform: rotate(45deg);
			-ms-transform: rotate(45deg);
			transform: rotate(45deg);
			text-align: center;
		}

		.fork-github a {
			color: #fff;
		}

		.gb-turntable a.gb-turntable-btn {
			border: none;
		}
	</style>
</head>

<body ontouchstart>
	<div class="wrapper typo" id="wrapper">
		<h1 id="scene-title" style="text-align: center;">抽奖</h1>
		<section id="turntable" class="gb-turntable">
			<div class="gb-turntable-container">
				<canvas class="gb-turntable-canvas" width="300" height="300px">抱歉！浏览器不支持。</canvas>
			</div>

			<a class="gb-turntable-btn" href="javascript:;">抽奖</a>
		</section>
	</div>

	<script src="js/GB-canvas-turntable.js"></script>
	<script>
		// 解析 URL 中的 scene 参数（默认是 default）
		function getSceneNameFromUrl() {
			const params = new URLSearchParams(window.location.search);
			return params.get("scene") || "default";
		}

		// 读取 JSON 场景配置文件
		function loadSceneConfig(sceneName, callback) {
			fetch(`sln/${sceneName}.json?t=${Date.now()}`)
				.then(response => {
					if (!response.ok) throw new Error("加载失败");
					return response.json();
				})
				.then(data => {
					callback(data);
				})
				.catch(error => {
					console.warn(`加载场景 ${sceneName}.json 失败，尝试加载默认配置`, error);
					// fallback: 默认配置
					fetch(`sln/default.json`)
						.then(res => res.json())
						.then(data => callback(data))
						.catch(() => callback([])); // 兜底空配置
				});
		}

		// Fisher-Yates 洗牌算法
		function shuffle(array) {
			for (let i = array.length - 1; i > 0; i--) {
				let j = Math.floor(Math.random() * (i + 1));
				[array[i], array[j]] = [array[j], array[i]];
			}
			return array;
		}

		// 根据权重扩展数组
		function expandByWeight(items) {
			const expanded = [];
			items.forEach(item => {
				const w = parseInt(item.weight || 1);
				console.log('weight: ' + w);
				for (let i = 0; i < w; i++) { expanded.push(item); }
			});
			return shuffle(expanded);
		}

		document.addEventListener('DOMContentLoaded', function () {
			const sceneName = getSceneNameFromUrl();
			console.log('scene: ' + sceneName);

			loadSceneConfig(sceneName, function (configData) {
				// 设置抽奖主题
				if (configData.name) {
					const titleEl = document.getElementById('scene-title');
					if (titleEl) { titleEl.textContent = configData.name; }
				}

				// 扩展并洗牌，缓存扩展后的数组
				const prizes = configData.prizes;
				console.log('prizes', configData);
				const expandedPrizes = expandByWeight(prizes);
				console.log('expandedPrizes', expandedPrizes);

				gbTurntable.init({
					id: 'turntable',
					config: function (callback) {
						callback && callback(prizes);
					},
					getPrize: function (callback) {
						const total = expandedPrizes.length;
						const index = Math.floor(Math.random() * total);
						// expandedPrizes[index] 就是抽中的奖品对象
						const indexInOriginal = prizes.indexOf(expandedPrizes[index]);
						const chances = 1;
						console.log(total, index, indexInOriginal);
						callback && callback([indexInOriginal, chances]);
					},
					gotBack: function (data) {
						console.log(data);
						alert('恭喜抽中：' + data);
					}
				});
			});
		});
	</script>
</body>

</html>